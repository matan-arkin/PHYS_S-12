<!DOCTYPE html>
<html lang="en" class="no-js">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:100,200,300,400,500,600,700,800,900" rel="stylesheet">

    <title>Ncompass - Week 9</title>
    
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="assets/css/soft-image.css">
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/templatemo-grad-school.css">
    <link rel="stylesheet" href="assets/css/owl.css">
    <link rel="stylesheet" href="assets/css/lightbox.css">
<!--
    
TemplateMo 557 Grad School

https://templatemo.com/tm-557-grad-school

-->
  </head>

<body>

   
  <!--header-->
  <header class="main-header clearfix" role="header">
    <div class="logo">
      <a href="#"><em>PHYS</em> S12</a>
    </div>
    <a href="#menu" class="menu-link"><i class="fa fa-bars"></i></a>
    <nav id="menu" class="main-nav" role="navigation">
      <ul class="main-menu">
        <li><a class="external" href="./index.html#section1">Home</a></li>
        <li><a class="external" href="./index.html#section2">Why <i style="color: #f5a425">N</i>compass?</a></li>
        <li class="has-submenu"><a class="external" href="./index.html#section4">How It's Made</a>
          <ul class="sub-menu">
            <li><a class="external" href="./week1.html">Intro</a></li>
            <li><a class="external" href="./week2.html">2D</a></li>
            <li><a class="external" href="./week3.html">Tools</a></li>
            <li><a class="external" href="./week4.html">Prototyping</a></li>
            <li><a class="external" href="./week5.html">Electronics</a></li>
            <li><a class="external" href="./week6.html">3D Printing</a></li>
            <li><a class="external" href="./week7.html">Input</a></li>
            <li><a class="external" href="./week8.html">Output</a></li>
            <li><a class="external" href="./week9.html">Networking</a></li>
            <li><a class="external" href="./week10.html">Machines</a></li>
          </ul>
        </li>
        <!-- <li><a href="#section4">Applications</a></li> -->
        <!-- <li><a href="#section5">Video</a></li> -->
        <li><a class="external" href="./index.html#section6">About</a></li>
      </ul>
    </nav>
  </header>

  <section class="section video" data-section="section5">
    <div class="container">
      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h4><em>Week 9</em><br> Networking / IoT</h4>
            <h2><i>AC</i>ontrol</h2>
            <p>Welcome to this week's project - <i>AC</i>ontrol! My timer-based Servo-controlled AC remote from homework 4 is making a comeback. This time we're connecting it to the internet and calling it <i>AC</i>ontrol. The idea is for me to be able to turn on the AC on my way home so the room is nice and cool upon arrival. <i>AC</i>ontrol could also be used to turn off a forgotten AC.</p></div>
        </div>
      </div>
      <br><br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h2>Version 1 - Firebase LED</h2>
            <p>To kick things off, I followed the <a href="https://nathanmelenbrink.github.io/intro-dig-fab/09_networking/huzzah1b.html">Firebase tutorial</a> for toggling an LED remotely. Here's how it works: Firebase maintains a database for me where I store a single String value: "LED_STATUS." Through the Firebases GUI, I can directly manipulate this String to be either "ON" or "OFF." Meanwhile, my ESP32 is connected to the internet via my home wifi. Every 1 second, it polls the server and asks for the current LED_STATUS. Based on the value it gets back, it either lights up the built in LED (at pin 13) or turns it off. So far so good.</p></div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <section>
              <video autoplay muted loop id="bg-video">
                <source src="assets/images/hw9_p1.mp4" type="video/mp4"/>
              </video>
          </section>
        </div>
      </div>
      <br><br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h2>Version 2 - Buttons, GUI</h2>
            <p>The next step was to add buttons for easier access. The HTML buttons are mapped to functions that trigger an HTTP POST message which travel over the intenet and instruct my database to set LED_STATUS either "ON" or "OFF." This proved quite difficult... I used the code from the <a href="https://nathanmelenbrink.github.io/intro-dig-fab/09_networking/huzzah1b.html">tutorial</a> and added in the config variable auto-generated by Firebase. Initially, I tried embedding this into my usual format for html pages, but that didn't work. I thought perhaps my format was getting in the way of something, so I tried moving things around and when that didn't work, dedicated a page just for the buttons, matching the template code from the tutorial and even tried "inspecting source" for the live example and using that code. Still nothing. Next, I recalled the tutorial instructed to push the code to GitHub, so I tried pushing and using that as opposed to the local version. Didn't work. <br><br>
            I returned to the Firebase site and tried copying "CDN" and "Config" options. I tried adding 'class = "no-js"' to my html element, as I saw that in the tutorial. Double checked my read/write rules were set to "true." <br><br>
            A little desperate, I used my phone to click the button and used a VPN on my computer, thinking perhaps a firewall rule was blocking the packet. A while later I was paging through the tutorial and reread the boilerplate code that I had copied. That's when I remembered Nathan's repeated warnings about version number from class that I had neglected, at my peril... That did it! </p></div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <section>
              <video autoplay muted loop id="bg-video">
                <source src="assets/images/hw9_v2.mp4" type="video/mp4"/>
              </video>
          </section>
        </div>
      </div>
      <br><br> 

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <p>You can try out the buttons for yourself <a href="week9_web_interface.html" target="_blank">here</a>, though they are no longer connected to anything :) And the ESP32 code for this, which is identical to Version 1's code, is available for download: <a href="assets/code/hw9/hw9_p1/hw9_p1.ino" download>hw9_p1.ino</a>. 
            </p></div>
        </div>
      </div>
      <br><br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h2>Version 3 - Porting Servo Code</h2>
            <p>My Servo code from homework 4 worked great, but it was made for the Metro, not the ESP32. Since the Metro has no built-in Wifi capabilities, I had to use the ESP32 for this project, and that meant porting my homework 4 code. So for this step, I focused only on getting my old AC timer to work - no fancy internet stuff for now. I wired the PWM line to pin 13 on the ESP32, ground to GND and Vin to 3V. This gave me pause. When I worked on homework 4 I had a bug where the Servo arm was reacting to my code and pressing the button, but couldn't get the button to press down enough to actually do anything. I found out I had accidentally wired the Servo's Vin to 3V instead of 5V. Wiring to 5V solved the issue. So I was worried that by wiring to 3V on the ESP32, I would get the same result. And worse, the ESP32 has no 5V pin, so I would have to use the Metro if this caused trouble. <br><br>
            The code for this step is available for download: <a href="assets/code/hw9/hw9_p2/hw9_p2.ino" download>hw9_p2.ino</a>.</p></div>
        </div>
      </div>
      <br><br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h2>Version 4 - 5V from Metro</h2>
            <p>As I feared, the Servo had trouble pressing the button. I tried increasing degrees, adding press time, but to no avail. I wired up my Metro's 5V to the Servo's Vin, tied the Metro's ground to the Servo's ground and the ESP32's pin 13 to the Servo's PWM line. Finally, I connected the Metro's GND to the ESP's GND to make sure their reference points for ground are identical. The code I used was the same as from the previous step. Here's what the setup looked like: </p></div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <img src="assets/images/hw9_v4_1.jpg" alt="git" width="100%">
          <br><br>
          <img src="assets/images/hw9_v4_2.jpg" alt="git" width="100%">
        </div>
        <div class="col-md-6">
          <img src="assets/images/hw9_v4_3.jpg" alt="git" width="100%">
          <br><br>
          <img src="assets/images/hw9_v4_4.jpg" alt="git" width="100%">
        </div>
      </div>
      <br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <p>This setup also gave me pause, as the Servo was now powered by 5V, but still connected to the ESP's PWM. I thought, perhaps the PWM would also need a 5V range for this to work. But this time the setup worked and the button press was successful. I ran it a few extra times to make sure. Then I recalled that the Metro is also a 3V-based chip and that its PWM output would have to be in the 3V range, not 5V, so this should work - and indeed it does.</p></div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <section>
              <video autoplay muted loop id="bg-video">
                <source src="assets/images/hw9_v4.mp4" type="video/mp4"/>
              </video>
          </section>
        </div>
      </div>
      <br><br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h2>Version 5 - <i>AC</i>ontrol, Bringing it All Together</h2>
            <p>For version 5 my job was to merge the Servo code and the networking code to remote control my AC. I used the networking code as a template and started making changes: I imported the relevant Servo library, defined the global variables and copied over the "press()" function. Then the interesting part: I changed the variable name from LED_STATUS to AC_STATUS. Where the LED would turn on or off, I made calls to the press() function. The html code also needed slight adjustment for the new variable name. I burned the code to the device and clicked the "Turn On" button. At first, I was excited to see the button press, but quickly less excited when it wouldn't stop pressing. <br><br>
            My mistake was that I called press() for any AC_STATUS. What I should've done was call it for every AC_STATUS *change*. To this end I added a new "prev_ac_status" variable. Each time I polled the server for a new status, I compared it to the previous status, then updated the previous status. Here is my fixed code:</p></div>
        </div>
        <div class="col-md-12 align-self-center">
          <pre class="prettyprint" style="padding: 2%;">// based on template from https://nathanmelenbrink.github.io/intro-dig-fab/09_networking/huzzah1b.html

#include <WiFi.h>                                 // esp32 library
#include <FirebaseESP32.h>                        // firebase library
#include <ESP32Servo.h>

#define FIREBASE_HOST "https://acontroller-aadb8-default-rtdb.europe-west1.firebasedatabase.app/"  // project name address from firebase id
#define FIREBASE_AUTH "cAdMvfIBB8BVwihI1A19RnIe37LriNSuFVNClYgs"                          // secret key generated from firebase
#define WIFI_SSID "my_ssid"                                // input your home or public wifi name
#define WIFI_PASSWORD "my_pass"                            // password of wifi ssid

Servo servo;
String fireString = "";                                          // AC status received from firebase
String prev_ac_status = "OFF";

//Define FirebaseESP32 data object
FirebaseData firebaseData;

void press() {
  // scan from 40 to 10 degrees, ie press down
  for(int angle = 40; angle &gt; 10; angle--)    
  {                                
    servo.write(angle);           
    delay(15);       
  }
  
  // hold for 1s
  delay(1000);
  
  // scan from 10 back to 40 degrees, ie let the button go
  for(int angle = 10; angle &lt; 40; angle++)  
  {                                  
    servo.write(angle);               
    delay(15);                   
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);                          // try to connect with wifi

  Serial.print("Connecting to ");
  Serial.print(WIFI_SSID);
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }

  Serial.println();
  Serial.print("Connected to ");
  Serial.println(WIFI_SSID);
  Serial.print("IP Address is : ");
  Serial.println(WiFi.localIP());                                // print local IP address
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);                  // connect to firebase
  Firebase.reconnectWiFi(true);
  Firebase.set(firebaseData, "/AC_STATUS", "OFF");              // set initial string of "OFF"
  
  servo.attach(13);
  servo.write(40);
}

void loop() {
  Firebase.get(firebaseData, "/AC_STATUS");                     // get AC status input from firebase
  fireString = firebaseData.stringData();                        // change to e.g. intData() or boolData()
  Serial.println(fireString);

  if (!(fireString == "ON" || fireString == "OFF")) {
    // invalid input
    Serial.println("Please send ON/OFF");
  }

  else {
    // valid input
    if (fireString != prev_ac_status) {                    // compare the input of AC status received from firebase
      // toggle required
      Serial.println("Toggling AC");
      press();
    }
    prev_ac_status = fireString;
  }

  delay(1000);                                 // not strictly necessary
}
          </pre>
        </div>
      </div>
      <br><br><br>

      <div class="row">
        <div class="col-md-12 align-self-center">
          <div class="left-content">
            <h2>Demo</h2>
            <p>I'm not going to publish the buttons here because I might actually use this and wouldn't want someone waking me up in the middle of the night with a creepy Servo motor sound. But here's me giving it a whirl: </p></div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-12">
          <section>
              <video autoplay muted loop id="bg-video">
                <source src="assets/images/hw9_v5.mp4" type="video/mp4"/>
              </video>
          </section>
        </div>
      </div>      
      <br><br><br>
    </div>
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <p><i class="fa fa-copyright"></i> Copyright 2020 by Grad School  
           | Design: <a href="https://templatemo.com" rel="sponsored" target="_parent">TemplateMo</a>
           | Modified by Matan Arkin 2021</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <!-- Bootstrap core JavaScript -->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?skin=desert"></script>
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script src="assets/js/isotope.min.js"></script>
    <script src="assets/js/owl-carousel.js"></script>
    <script src="assets/js/lightbox.js"></script>
    <script src="assets/js/tabs.js"></script>
    <script src="assets/js/video.js"></script>
    <script src="assets/js/slick-slider.js"></script>
    <script src="assets/js/custom.js"></script>
    <script>
        //according to loftblog tut
        $('.nav li:first').addClass('active');

        var showSection = function showSection(section, isAnimate) {
          var
          direction = section.replace(/#/, ''),
          reqSection = $('.section').filter('[data-section="' + direction + '"]'),
          reqSectionPos = reqSection.offset().top - 0;

          if (isAnimate) {
            $('body, html').animate({
              scrollTop: reqSectionPos },
            800);
          } else {
            $('body, html').scrollTop(reqSectionPos);
          }

        };

        var checkSection = function checkSection() {
          $('.section').each(function () {
            var
            $this = $(this),
            topEdge = $this.offset().top - 80,
            bottomEdge = topEdge + $this.height(),
            wScroll = $(window).scrollTop();
            if (topEdge < wScroll && bottomEdge > wScroll) {
              var
              currentId = $this.data('section'),
              reqLink = $('a').filter('[href*=\\#' + currentId + ']');
              reqLink.closest('li').addClass('active').
              siblings().removeClass('active');
            }
          });
        };

        $('.main-menu, .scroll-to-section').on('click', 'a', function (e) {
          if($(e.target).hasClass('external')) {
            return;
          }
          e.preventDefault();
          $('#menu').removeClass('active');
          showSection($(this).attr('href'), true);
        });

        $(window).scroll(function () {
          checkSection();
        });
    </script>

    
</body>
</html>